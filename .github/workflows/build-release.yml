name: Build LocalTrainer and Release

on:
    push:
        tags:
            - "v*.*.*"
    workflow_dispatch:

jobs:
    build:
        name: Build (${{ matrix.artifact }})
        runs-on: ${{ matrix.os }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: windows-latest
                      artifact: windows-x64
                    - os: ubuntu-latest
                      artifact: linux-x64
                    - os: macos-latest
                      artifact: macos-arm64
                    - os: macos-15-intel
                      artifact: macos-x64

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install dependencies
              shell: bash
              run: |
                  python -m pip install --upgrade pip
                  python -m pip install pyinstaller numpy scipy matplotlib torch scikit-learn h5py torchdiffeq pandas requests flask flask-cors

            - name: Build executable (PyInstaller)
              shell: bash
              working-directory: local_trainer
              run: |
                  python -m PyInstaller --noconfirm --clean --onefile local_trainer.py \
                    --name HYBpy_LocalTrainer \
                    --paths .. \
                    --hidden-import hybdata \
                    --hidden-import hybtrain \
                    --hidden-import csv2json

            - name: Package ZIP
              shell: bash
              run: |
                  if [[ "${{ runner.os }}" == "Windows" ]]; then
                    7z a -tzip "HYBpy-LocalTrainer-${{ matrix.artifact }}.zip" "local_trainer/dist/HYBpy_LocalTrainer.exe"
                  else
                    zip -j "HYBpy-LocalTrainer-${{ matrix.artifact }}.zip" "local_trainer/dist/HYBpy_LocalTrainer"
                  fi

            - name: Upload artifact
              uses: actions/upload-artifact@v4
              with:
                  name: HYBpy-LocalTrainer-${{ matrix.artifact }}
                  path: HYBpy-LocalTrainer-${{ matrix.artifact }}.zip

    release:
        name: Create GitHub Release
        runs-on: ubuntu-latest
        needs: build
        permissions:
            contents: write

        steps:
            - name: Download artifacts
              uses: actions/download-artifact@v4
              with:
                  path: dist

            - name: Publish Release
              uses: softprops/action-gh-release@v2
              with:
                  files: dist/**/HYBpy-LocalTrainer-*.zip
